name: ğŸš€ DÃ©ploiement Netlify

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ğŸ“¦ Installation des dÃ©pendances
      run: npm ci
      
    - name: ğŸ—ï¸ Build de production
      run: npm run build:netlify
      
    - name: ğŸ§ª Tests
      run: npm test -- --watch=false --browsers=ChromeHeadless
      
    - name: ğŸ“ PrÃ©paration des fichiers Netlify
      run: |
        mkdir -p netlify/functions
        cp -r dist/label-conseil/browser/* netlify/functions/
        
    - name: ğŸš€ DÃ©ploiement sur Netlify
      uses: nwtgck/actions-netlify@v2.0
      with:
        publish-dir: './dist/label-conseil/browser'
        functions-dir: './netlify/functions'
        edge-functions-dir: './netlify/edge-functions'
        production-branch: main
        github-token: ${{ secrets.GITHUB_TOKEN }}
        deploy-message: "ğŸš€ DÃ©ploiement automatique - ${{ github.sha }}"
        
    - name: ğŸ”— URL de dÃ©ploiement
      run: |
        echo "ğŸŒ Site dÃ©ployÃ©: ${{ steps.deploy.outputs.url }}"
        echo "ğŸ”— URL de preview: ${{ steps.deploy.outputs.deploy-url }}"
